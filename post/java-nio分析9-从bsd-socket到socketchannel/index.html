<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Java NIO分析(9): 从BSD socket到SocketChannel | Chris的博客</title><meta property="og:title" content="Java NIO分析(9): 从BSD socket到SocketChannel - Chris的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2018-07-16T07:56:32+08:00"><meta property="article:modified_time" content="2018-07-16T07:56:32+08:00"><meta name=Keywords content="golang,go语言,sound2gd,Chris,java,jvm,android,博客,项目管理,金融科技,clojure,软件架构,公众号,小程序"><meta name=description content="Java NIO分析(9): 从BSD socket到SocketChannel"><meta name=author content="Chris Wang"><meta property="og:url" content="https://www.sound2gd.wang/post/java-nio%E5%88%86%E6%9E%909-%E4%BB%8Ebsd-socket%E5%88%B0socketchannel/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css rel=stylesheet></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://www.sound2gd.wang/>Chris的博客</a><p class=description>专注于Jvm(openjdk)、Go语言(golang)、云计算、效率工具、项目管理、软件架构、金融科技</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://www.sound2gd.wang/>首页</a>
<a href=https://www.sound2gd.wang/archives/ title=归档>归档</a>
<a href=https://www.sound2gd.wang/life/ title=学习>学习</a>
<a href=https://www.sound2gd.wang/about/ title=关于>关于</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Java NIO分析(9): 从BSD socket到SocketChannel</h1></header><date class="post-meta meta-date">2018年7月16日</date><div class=post-content><p>前面我们讲了高并发核心<code>Selector</code>的源码分析，看到其对操作系统I/O多路复用的简单封装。
有了I/O多路复用之后，我们还需要<strong>非阻塞的socket读写操作</strong>.</p><p>因为内核告诉你<strong>A连接</strong>有数据可读，你想要读1K, 事实上只读到了0.5K, 如果使用传统的
socket API, 那么进程或者线程会在这里<strong>阻塞</strong>，浪费了CPU的时钟周期和珍贵的线程资源。
使用非阻塞就能在没有读满之前立刻返回，数据先放内存里，然后继续读下一个<strong>B连接</strong>的数据。</p><p><code>SocketChannel</code>就是NIO对于非阻塞socket操作的支持的组件，其在socket上封装了一层, 所以我们先从<code>Socket API</code>说起。</p><h1 id=1-大名鼎鼎的socket简介>1. 大名鼎鼎的Socket简介</h1><p>在<a href=/post/java-nio%E5%88%86%E6%9E%902-i/o%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E5%8E%86%E5%8F%B2%E6%9D%82%E8%B0%88/>Java-NIO分析-2-I-O多路复用历史杂谈</a>中我们讲过，1982年, BSD那帮人发布了<a href=http://digitalassets.lib.berkeley.edu/techreports/ucb/text/CSD-83-146.pdf>Socket和TCP/IP协议栈</a>和select系统调用.</p><p>当时Unix系统严重缺乏进程间通信的手段, 全靠一手出神入化的fork大法在维持
所以Socket发布的时候，是用来做<code>进程间通信(IPC)的</code>.</p><p>放在36年后的今天，这个定义也不过时
<strong>网络通信其实就是不同机器的不同操作系统上socket之间的通信</strong>.</p><h2 id=11-socket-api怎么玩>1.1 Socket API怎么玩？</h2><p>先放张图，从<a href=https://www.ibm.com/support/knowledgecenter/ssw_ibm_i_71/rzab6/howdosockets.htm>IBM那里的文章</a>抄过来的</p><p><a data-fancybox=gallery href=http://img.sound2gd.wang/2018/07/16/20180716081628.png-t><img class=mx-auto alt src=http://img.sound2gd.wang/2018/07/16/20180716081628.png-t></a></p><p>这就是典型的socket通信的流程。</p><ol><li>通过socket()函数创建一个socket fd, 代表通信端点</li><li>绑定端口，协议栈，Socket类型(TCP就是流式Socket)</li><li>监听, 完了就可以接口客户端的TCP链接了，这个时候建立的TCP链接和accept的不一样，会存在内核的某个队列里，长度由你们都熟悉的<code>SO_BACKLOG</code>指定</li><li>接收链接</li><li>通信, 愉快的交换数据</li><li>关闭链接</li></ol><p>socket通信需要知道5元组(本地IP+端口，服务器IP+端口，协议)</p><p>话说TCP协议实现上这里有个历史缺陷，也是<code>SYN Flood</code>的攻击原理，在TCP3次握手的时候，假如只握手一次，之后就不管了。那么<code>SYN队列</code>会被撑满，之后就不能建立TCP链接了(一般会被拒绝，看操作系统实现).比较可怕的是这都是发生在内核的，还没到应用层, 开发人员一脸懵逼</p><p><a data-fancybox=gallery href=http://img.sound2gd.wang/2018/07/16/20180716083309.png-t><img class=mx-auto alt src=http://img.sound2gd.wang/2018/07/16/20180716083309.png-t></a></p><h2 id=12-tcpip发过来的包去哪了>1.2 TCP/IP发过来的包去哪了？</h2><p>TCP/IP协议栈将网络分成四层，分别是:</p><ul><li>应用层: 通常就是指你自己写的程序</li><li>传输层(TCP): 其实传输层协议还有UDP,只是我们平时用得少。TCP是一种面向流的可靠传输</li><li>网络层(IP): 基本就是靠IP协议，知道地址和端口来寻找目标机器</li><li>物理层: 就是光纤，网线这种东西</li></ul><p><a data-fancybox=gallery href=http://img.sound2gd.wang/2018/07/17/20180717081127.png-t><img class=mx-auto alt src=http://img.sound2gd.wang/2018/07/17/20180717081127.png-t></a></p><p>粗略得讲，IP协议保证网络包通过路由器能投递给目标机器网卡，经过网卡驱动会触发一个中断给
内核，内核会根据TCP/IP协议栈做CRC校检，然后层层解包还原用户数据,然后复制数据到socket
的读写缓冲区. 以上操作都是在<strong>内核空间</strong>完成的。</p><p><a data-fancybox=gallery href=http://img.sound2gd.wang/2018/07/16/20180716224333.png-t><img class=mx-auto alt src=http://img.sound2gd.wang/2018/07/16/20180716224333.png-t></a></p><p>如果socket fd被加入到了多路复用的监听队列里，如<code>epoll_ctl</code>加入的fd,那么在下次<code>epoll_wait</code>的时候，将会返回该socket有数据可读可写, 过程即完整的一次网络I/O事件通知。</p><p>这个时候<strong>用户空间</strong>内的应用进程直接调用socket的read方法，内核就会将数据从socket的读缓冲区复制到应用进程的缓冲区了。</p><h1 id=2-socketchannel详解>2. SocketChannel详解</h1><p><code>SocketChannel</code>是对传统Java Socket API的改进，主要是支持了<strong>非阻塞的读写</strong>。同时改进了传统的单向流API, Channel同时支持读写(其实就是加了个中间层<code>Buffer</code>)。</p><h2 id=21-创建一个socketchannel时做了什么>2.1 创建一个SocketChannel时做了什么</h2><p>通过<code>SocketChannel.open()</code>可以打开一个<code>SocketChannel</code>, 最后还是委托给<code>SelectorProvider</code>的<code>openSocketChannel</code>方法</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#998;font-style:italic>// sun.nio.ch.SelectorProvider
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>public</span> SocketChannel <span style=color:#900;font-weight:700>openSocketChannel</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 调用SocketChannelImpl的构造器
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>new</span> SocketChannelImpl<span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>this</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// sun.nio.ch.SocketChannelImpl
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    SocketChannelImpl<span style=color:#000;font-weight:700>(</span>SelectorProvider sp<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>super</span><span style=color:#000;font-weight:700>(</span>sp<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 创建socket fd
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>fd</span> <span style=color:#000;font-weight:700>=</span> Net<span style=color:#000;font-weight:700>.</span><span style=color:teal>socket</span><span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>true</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 获取socket fd的值
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>fdVal</span> <span style=color:#000;font-weight:700>=</span> IOUtil<span style=color:#000;font-weight:700>.</span><span style=color:teal>fdVal</span><span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 初始化SocketChannel状态, 状态不多，总共就6个
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#998;font-style:italic>// 未初始化，未连接，正在连接，已连接，断开连接中，已断开
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>state</span> <span style=color:#000;font-weight:700>=</span> ST_UNCONNECTED<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// sun.nio.ch.Net
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>static</span> FileDescriptor <span style=color:#900;font-weight:700>socket</span><span style=color:#000;font-weight:700>(</span>ProtocolFamily family<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>boolean</span> stream<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#458;font-weight:700>boolean</span> preferIPv6 <span style=color:#000;font-weight:700>=</span> isIPv6Available<span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>&amp;&amp;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>(</span>family <span style=color:#000;font-weight:700>!=</span> StandardProtocolFamily<span style=color:#000;font-weight:700>.</span><span style=color:teal>INET</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 最后调用的是socket0
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>return</span> IOUtil<span style=color:#000;font-weight:700>.</span><span style=color:teal>newFD</span><span style=color:#000;font-weight:700>(</span>socket0<span style=color:#000;font-weight:700>(</span>preferIPv6<span style=color:#000;font-weight:700>,</span> stream<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>false</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// Due to oddities SO_REUSEADDR on windows reuse is ignored
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>static</span> <span style=color:#000;font-weight:700>native</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>socket0</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>boolean</span> preferIPv6<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>boolean</span> stream<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>boolean</span> reuse<span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，最后还是靠一个native方法<code>socket0</code>来创建socket fd,打开<code>jdk/src/solaris/native/sun/nio/ch/Net.c</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>JNIEXPORT <span style=color:#458;font-weight:700>int</span> JNICALL
</span></span><span style=display:flex><span><span style=color:#900;font-weight:700>Java_sun_nio_ch_Net_socket0</span>(JNIEnv <span style=color:#000;font-weight:700>*</span>env, jclass cl, jboolean preferIPv6,
</span></span><span style=display:flex><span>                            jboolean stream, jboolean reuse)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> fd;
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> type <span style=color:#000;font-weight:700>=</span> (stream <span style=color:#000;font-weight:700>?</span> <span style=color:#900;font-weight:700>SOCK_STREAM</span> : SOCK_DGRAM);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// 老朋友socket函数
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    fd <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>socket</span>(domain, type, <span style=color:#099>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> (fd <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#099>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>handleSocketError</span>(env, errno);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ....<span style=color:#a61717;background-color:#e3d2d2>省略非关键代码</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// 设置是否重用地址，如果打开的是ServerSocketChannel
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#998;font-style:italic>// 默认是重用的，其他普通SocketChannel默认不重用
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#998;font-style:italic>// 重用和不重用的区别在于，就算你关掉了程序，你绑定的
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#998;font-style:italic>// 本地端口也在一定时间内是已使用的(address already in use)
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>if</span> (reuse) {
</span></span><span style=display:flex><span>        <span style=color:#458;font-weight:700>int</span> arg <span style=color:#000;font-weight:700>=</span> <span style=color:#099>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> (<span style=color:#900;font-weight:700>setsockopt</span>(fd, SOL_SOCKET, SO_REUSEADDR, (<span style=color:#458;font-weight:700>char</span><span style=color:#000;font-weight:700>*</span>)<span style=color:#000;font-weight:700>&amp;</span>arg,
</span></span><span style=display:flex><span>                       <span style=color:#000;font-weight:700>sizeof</span>(arg)) <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#099>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#900;font-weight:700>JNU_ThrowByNameWithLastError</span>(env,
</span></span><span style=display:flex><span>                                         JNU_JAVANETPKG <span style=color:#d14>&#34;SocketException&#34;</span>,
</span></span><span style=display:flex><span>                                         <span style=color:#d14>&#34;Unable to set SO_REUSEADDR&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#900;font-weight:700>close</span>(fd);
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>-</span><span style=color:#099>1</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>return</span> fd;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>果然，底层还是<code>socket</code>函数，这样一个socket fd就创建好了。</p><p>PS: 其实创建个socket fd操作系统内核做了很多事情的，要判断一大堆东西，还要创建和初始化读写缓冲区，加自旋锁等.</p><h2 id=22-如何实现非阻塞>2.2 如何实现非阻塞</h2><p>正常在c里我们实现非阻塞是靠<code>fcntl</code>这个函数，这个函数全称就是<code>file control</code>,
通过它可以管理fd的各种属性，比如设置fd的阻塞与否。</p><p><code>fcntl</code>的函数签名为:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>#include</span> <span style=color:#999;font-weight:700;font-style:italic>&lt;fcntl.h&gt;</span><span style=color:#999;font-weight:700;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>fcntl</span>(<span style=color:#458;font-weight:700>int</span> fildes, <span style=color:#458;font-weight:700>int</span> cmd, ...);
</span></span></code></pre></td></tr></table></div></div><p>第一个参数是传入的fd, 第二个参数是操作类型，后面是flag
要设置非阻塞，操作类型是<code>F_SETFL</code>和<code>F_GETFL</code>,flag是<code>O_NONBLOCK</code></p><p>那么JVM是怎么做的呢，在SocketChannel上有一个<code>configureBlocking</code>函数，这个函数是设置当前<code>SocketChannel</code>是否是阻塞的，和selector一起用的时候一定要设置成非阻塞才有意义, 阻塞的话就不需要IO多路复用的事件通知了。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#998;font-style:italic>// java.nio.channels.spi.AbstractSelectableChannel
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>final</span> SelectableChannel <span style=color:#900;font-weight:700>configureBlocking</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>boolean</span> block<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>throws</span> IOException
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 模板方法模式，调用子类的实现
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        implConfigureBlocking<span style=color:#000;font-weight:700>(</span>block<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>this</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在<code>SocketChannelImpl</code>里看</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#000;font-weight:700>protected</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>implConfigureBlocking</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>boolean</span> block<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        IOUtil<span style=color:#000;font-weight:700>.</span><span style=color:teal>configureBlocking</span><span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>,</span> block<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span></code></pre></td></tr></table></div></div><p>将这个操作又交给了<code>IOUtil</code>的<code>configureBlocking</code>, 同时还传入了我们上面创建的socket fd. 打开<code>IOUtil</code>一看</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>static</span> <span style=color:#000;font-weight:700>native</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>configureBlocking</span><span style=color:#000;font-weight:700>(</span>FileDescriptor fd<span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                                <span style=color:#458;font-weight:700>boolean</span> blocking<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>throws</span> IOException<span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></td></tr></table></div></div><p>还是要找c的实现，打开<code>IOUtil.c</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>JNIEXPORT <span style=color:#458;font-weight:700>void</span> JNICALL
</span></span><span style=display:flex><span><span style=color:#900;font-weight:700>Java_sun_nio_ch_IOUtil_configureBlocking</span>(JNIEnv <span style=color:#000;font-weight:700>*</span>env, jclass clazz,
</span></span><span style=display:flex><span>                                         jobject fdo, jboolean blocking)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> (<span style=color:#900;font-weight:700>configureBlocking</span>(<span style=color:#900;font-weight:700>fdval</span>(env, fdo), blocking) <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#099>0</span>)
</span></span><span style=display:flex><span>        <span style=color:#900;font-weight:700>JNU_ThrowIOExceptionWithLastError</span>(env, <span style=color:#d14>&#34;Configure blocking failed&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>static</span> <span style=color:#458;font-weight:700>int</span>
</span></span><span style=display:flex><span><span style=color:#900;font-weight:700>configureBlocking</span>(<span style=color:#458;font-weight:700>int</span> fd, jboolean blocking)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// 所以还是靠file control
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#458;font-weight:700>int</span> flags <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>fcntl</span>(fd, F_GETFL);
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> newflags <span style=color:#000;font-weight:700>=</span> blocking <span style=color:#000;font-weight:700>?</span> (flags <span style=color:#000;font-weight:700>&amp;</span> <span style=color:#000;font-weight:700>~</span>O_NONBLOCK) <span style=color:#000;font-weight:700>:</span> (flags <span style=color:#000;font-weight:700>|</span> O_NONBLOCK);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>return</span> (flags <span style=color:#000;font-weight:700>==</span> newflags) <span style=color:#000;font-weight:700>?</span> <span style=color:#099>0</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#900;font-weight:700>fcntl</span>(fd, F_SETFL, newflags);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>可以看到，JVM也是靠<code>fcntl</code>来实现非阻塞的，所以服务端编程知道一些底层的API还是有价值的和有必要的。</p><h2 id=23-socketchannel的读写>2.3 SocketChannel的读写</h2><p>那么SocketChannel是如何读写呢，打开<code>SocketChannelImpl</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#000;font-weight:700>public</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>read</span><span style=color:#000;font-weight:700>(</span>ByteBuffer buf<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>      <span style=color:#998;font-style:italic>// n表示读到的数据长度
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>      <span style=color:#458;font-weight:700>int</span> n <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>for</span> <span style=color:#000;font-weight:700>(;;)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#998;font-style:italic>// 从socket fd里读数据，长度由buf决定
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>          n <span style=color:#000;font-weight:700>=</span> IOUtil<span style=color:#000;font-weight:700>.</span><span style=color:teal>read</span><span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>,</span> buf<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>-</span><span style=color:#099>1</span><span style=color:#000;font-weight:700>,</span> nd<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>((</span>n <span style=color:#000;font-weight:700>==</span> IOStatus<span style=color:#000;font-weight:700>.</span><span style=color:teal>INTERRUPTED</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>&amp;&amp;</span> isOpen<span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>              <span style=color:#998;font-style:italic>// The system call was interrupted but the channel
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>              <span style=color:#998;font-style:italic>// is still open, so retry
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>              <span style=color:#000;font-weight:700>continue</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>return</span> IOStatus<span style=color:#000;font-weight:700>.</span><span style=color:teal>normalize</span><span style=color:#000;font-weight:700>(</span>n<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>读交给了<code>IOUtil</code>的<code>read</code>方法</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#000;font-weight:700>static</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>read</span><span style=color:#000;font-weight:700>(</span>FileDescriptor fd<span style=color:#000;font-weight:700>,</span> ByteBuffer dst<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>long</span> position<span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                    NativeDispatcher nd<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>throws</span> IOException
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>dst<span style=color:#000;font-weight:700>.</span><span style=color:teal>isReadOnly</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>throw</span> <span style=color:#000;font-weight:700>new</span> IllegalArgumentException<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;Read-only buffer&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 判断是不是DirectBuffer，是直接读进去
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#998;font-style:italic>// DirectBuffer是有名的冰山对象，其后可能关联着一堆直接内存
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>dst <span style=color:#000;font-weight:700>instanceof</span> DirectBuffer<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>return</span> readIntoNativeBuffer<span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>,</span> dst<span style=color:#000;font-weight:700>,</span> position<span style=color:#000;font-weight:700>,</span> nd<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 如果传入的不是DirectBuffer,那么使用临时的DirectBuffer
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#998;font-style:italic>// Substitute a native buffer
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        ByteBuffer bb <span style=color:#000;font-weight:700>=</span> Util<span style=color:#000;font-weight:700>.</span><span style=color:teal>getTemporaryDirectBuffer</span><span style=color:#000;font-weight:700>(</span>dst<span style=color:#000;font-weight:700>.</span><span style=color:teal>remaining</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#458;font-weight:700>int</span> n <span style=color:#000;font-weight:700>=</span> readIntoNativeBuffer<span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>,</span> bb<span style=color:#000;font-weight:700>,</span> position<span style=color:#000;font-weight:700>,</span> nd<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            bb<span style=color:#000;font-weight:700>.</span><span style=color:teal>flip</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>n <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                dst<span style=color:#000;font-weight:700>.</span><span style=color:teal>put</span><span style=color:#000;font-weight:700>(</span>bb<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>return</span> n<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>finally</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            Util<span style=color:#000;font-weight:700>.</span><span style=color:teal>offerFirstTemporaryDirectBuffer</span><span style=color:#000;font-weight:700>(</span>bb<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>static</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>readIntoNativeBuffer</span><span style=color:#000;font-weight:700>(</span>FileDescriptor fd<span style=color:#000;font-weight:700>,</span> ByteBuffer bb<span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                            <span style=color:#458;font-weight:700>long</span> position<span style=color:#000;font-weight:700>,</span> NativeDispatcher nd<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>throws</span> IOException
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#458;font-weight:700>int</span> pos <span style=color:#000;font-weight:700>=</span> bb<span style=color:#000;font-weight:700>.</span><span style=color:teal>position</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#458;font-weight:700>int</span> lim <span style=color:#000;font-weight:700>=</span> bb<span style=color:#000;font-weight:700>.</span><span style=color:teal>limit</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>assert</span> <span style=color:#000;font-weight:700>(</span>pos <span style=color:#000;font-weight:700>&lt;=</span> lim<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#458;font-weight:700>int</span> rem <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span>pos <span style=color:#000;font-weight:700>&lt;=</span> lim <span style=color:#000;font-weight:700>?</span> lim <span style=color:#000;font-weight:700>-</span> pos <span style=color:#000;font-weight:700>:</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>rem <span style=color:#000;font-weight:700>==</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>return</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#458;font-weight:700>int</span> n <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 调用本地方法去读
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#998;font-style:italic>// 要读socket fd一定要知道起始地址
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#998;font-style:italic>// 感兴趣可以看看https://stackoverflow.com/questions/11981474/pread-and-lseek-not-working-on-socket-file-descriptor
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#998;font-style:italic>// 调用完毕bb的那个DirectBuffer的直接内存里就有数据了
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>position <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>-</span><span style=color:#099>1</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            n <span style=color:#000;font-weight:700>=</span> nd<span style=color:#000;font-weight:700>.</span><span style=color:teal>pread</span><span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>((</span>DirectBuffer<span style=color:#000;font-weight:700>)</span>bb<span style=color:#000;font-weight:700>).</span><span style=color:teal>address</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>+</span> pos<span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                         rem<span style=color:#000;font-weight:700>,</span> position<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            n <span style=color:#000;font-weight:700>=</span> nd<span style=color:#000;font-weight:700>.</span><span style=color:teal>read</span><span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>((</span>DirectBuffer<span style=color:#000;font-weight:700>)</span>bb<span style=color:#000;font-weight:700>).</span><span style=color:teal>address</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>+</span> pos<span style=color:#000;font-weight:700>,</span> rem<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>n <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            bb<span style=color:#000;font-weight:700>.</span><span style=color:teal>position</span><span style=color:#000;font-weight:700>(</span>pos <span style=color:#000;font-weight:700>+</span> n<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span> n<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>static</span> <span style=color:#000;font-weight:700>native</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>pread0</span><span style=color:#000;font-weight:700>(</span>FileDescriptor fd<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>long</span> address<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>int</span> len<span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                             <span style=color:#458;font-weight:700>long</span> position<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException<span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里解释下为啥一定要用<code>DirectBuffer</code>, 在JVM里是有GC的，但在调用Socket Api进行读写通信的时候，需传入的是一个固定的内存地址，假如数据使用的是堆内地址，GC之后对象地址就变了，这时socket读写就会崩。</p><p>上面还有最后一个<code>pread0</code>本地方法，这个是文件IO函数，第一个参数传入socket fd的时候，<strong>将会从socket的读缓冲区复制数据</strong>到目标地址，这里不细讲,感兴趣可以看看<a href=https://blog.csdn.net/zongcai249/article/details/17598411>这篇文章</a></p><p><code>SocketChannel</code>如何实现<strong>写操作</strong>就交给读者自行完成了，和读差不多。</p><h1 id=3-总结>3. 总结</h1><p>本节介绍了祖传的<code>Socket API</code>是怎么一回事，以及数据是怎么从网络到达应用进程的(因为老有人问).</p><p>同时分析了openjdk对<code>SocketChannel</code>的实现细节，其实都是对底层<code>socket</code>的API封装, 所以熟知一些关键API还是有必要的。</p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://www.sound2gd.wang/>Chris Wang</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://www.sound2gd.wang/post/java-nio%E5%88%86%E6%9E%909-%E4%BB%8Ebsd-socket%E5%88%B0socketchannel/>https://www.sound2gd.wang/post/java-nio%E5%88%86%E6%9E%909-%E4%BB%8Ebsd-socket%E5%88%B0socketchannel/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br><div class=post-archive><h2>See Also</h2><ul class=listing><li><a href=/post/java-nio%E5%88%86%E6%9E%908-%E9%AB%98%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83selector%E8%AF%A6%E8%A7%A3/>Java NIO分析(8): 高并发核心Selector详解</a></li><li><a href=/post/java-nio%E5%88%86%E6%9E%907-nio%E6%A0%B8%E5%BF%83%E4%B9%8Bchannelbuffer%E5%92%8Cselector%E7%AE%80%E4%BB%8B/>Java NIO分析(7): NIO核心之Channel,Buffer和Selector简介</a></li><li><a href=/post/java-nio%E5%88%86%E6%9E%906-%E4%BB%8Ebio%E5%88%B0nio-%E8%AE%BE%E8%AE%A1%E5%92%8C%E6%A6%82%E5%BF%B5/>Java NIO分析(6): 从BIO到NIO-设计和概念</a></li><li><a href=/post/java-nio%E5%88%86%E6%9E%905-i/o%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bepoll%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/>Java NIO分析(5): I/O多路复用之epoll系统调用</a></li><li><a href=/post/java-nio%E5%88%86%E6%9E%904-i/o%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bpoll%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/>Java NIO分析(4): I/O多路复用之poll系统调用</a></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a href=/tags/nio>NIO</a></li></ul></div></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=sound2gd/blog-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2023 <a href=https://www.sound2gd.wang/>Chris的博客 By Chris Wang</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>浙ICP备18046106号</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N5MSKS0SN8"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N5MSKS0SN8",{anonymize_ip:!1})}</script></div><div id=secondary><section class=widget><form id=search action=https://www.sound2gd.wang/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://www.sound2gd.wang/>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://www.sound2gd.wang/post/d2adf54d/ title="Stable Diffusion咒语整理">Stable Diffusion咒语整理</a></li><li><a href=https://www.sound2gd.wang/post/bcd1a91c/ title=盘点rust写的好用命令行工具>盘点rust写的好用命令行工具</a></li><li><a href=https://www.sound2gd.wang/post/556f376d/ title=2022年Clojure技术栈推荐>2022年Clojure技术栈推荐</a></li><li><a href=https://www.sound2gd.wang/post/jvm%E6%8B%BE%E9%81%975-%E5%AF%B9%E8%B1%A1%E5%A4%A7%E5%B0%8F%E8%AE%A1%E7%AE%97/ title="JVM拾遗(5): 对象大小计算">JVM拾遗(5): 对象大小计算</a></li><li><a href=https://www.sound2gd.wang/post/jvm%E6%8B%BE%E9%81%974-java%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA%E5%8F%8A%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/ title="JVM拾遗(4): Java对象的创建及内存布局">JVM拾遗(4): Java对象的创建及内存布局</a></li><li><a href=https://www.sound2gd.wang/post/jvm%E6%8B%BE%E9%81%973-%E7%B1%BB%E8%A3%85%E8%BD%BD%E6%9C%BA%E5%88%B6/ title="JVM拾遗(3): 类装载机制">JVM拾遗(3): 类装载机制</a></li><li><a href=https://www.sound2gd.wang/post/jvm%E6%8B%BE%E9%81%972-%E5%B9%B3%E5%8F%B0%E6%97%A0%E5%85%B3%E6%80%A7%E5%9F%BA%E7%9F%B3%E4%B9%8Bclass%E8%A7%A3%E6%9E%90/ title="JVM拾遗(2): 平台无关性基石之Class解析">JVM拾遗(2): 平台无关性基石之Class解析</a></li><li><a href=https://www.sound2gd.wang/post/jvm%E6%8B%BE%E9%81%971-%E4%B8%87%E7%B1%B3%E9%AB%98%E7%A9%BA%E7%9C%8Bjvm/ title="JVM拾遗(1): 万米高空看JVM">JVM拾遗(1): 万米高空看JVM</a></li><li><a href=https://www.sound2gd.wang/post/java-nio%E5%88%86%E6%9E%9012-nio%E6%80%BB%E7%BB%93/ title="Java NIO分析(12): NIO总结">Java NIO分析(12): NIO总结</a></li><li><a href=https://www.sound2gd.wang/post/java-nio%E5%88%86%E6%9E%9011-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF%E4%BB%A5%E5%8F%8Anio%E7%9A%84%E6%94%AF%E6%8C%81/ title="Java NIO分析(11): 零拷贝技术以及NIO的支持">Java NIO分析(11): 零拷贝技术以及NIO的支持</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list><li><a href=https://www.sound2gd.wang/categories/clojure/>Clojure (1)</a></li><li><a href=https://www.sound2gd.wang/categories/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/>年终总结 (1)</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud><a href=https://www.sound2gd.wang/tags/2021/>2021</a>
<a href=https://www.sound2gd.wang/tags/clojure/>Clojure</a>
<a href=https://www.sound2gd.wang/tags/java-jvm/>JAVA JVM</a>
<a href=https://www.sound2gd.wang/tags/jvm-java/>JVM JAVA</a>
<a href=https://www.sound2gd.wang/tags/nio/>NIO</a>
<a href=https://www.sound2gd.wang/tags/nio-linux/>NIO Linux</a>
<a href=https://www.sound2gd.wang/tags/%E4%BA%BA%E7%94%9F/>人生</a>
<a href=https://www.sound2gd.wang/tags/%E5%B7%A5%E7%A8%8B%E6%8A%80%E6%9C%AF/>工程技术</a>
<a href=https://www.sound2gd.wang/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/>年终总结</a>
<a href=https://www.sound2gd.wang/tags/%E6%9D%82%E8%B0%88/>杂谈</a></div></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://www.sound2gd.wang/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>