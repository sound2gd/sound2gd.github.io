<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Java NIO分析(8): 高并发核心Selector详解 | Chris的博客</title><meta property="og:title" content="Java NIO分析(8): 高并发核心Selector详解 - Chris的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2018-07-12T23:11:27+08:00"><meta property="article:modified_time" content="2018-07-12T23:11:27+08:00"><meta name=Keywords content="golang,go语言,sound2gd,Chris,java,jvm,android,博客,项目管理,金融科技,clojure,软件架构,公众号,小程序"><meta name=description content="Java NIO分析(8): 高并发核心Selector详解"><meta name=author content="Chris Wang"><meta property="og:url" content="http://sound2gd.wang/post/java-nio%E5%88%86%E6%9E%908-%E9%AB%98%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83selector%E8%AF%A6%E8%A7%A3/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<link href=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css rel=stylesheet></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=http://sound2gd.wang/>Chris的博客</a><p class=description>专注于Jvm(openjdk)、Go语言(golang)、效率工具、项目管理、软件架构、金融科技</p></div><div><nav id=nav-menu class=clearfix><a class=current href=http://sound2gd.wang/>首页</a>
<a href=http://sound2gd.wang/archives/ title=归档>归档</a>
<a href=http://sound2gd.wang/life/ title=学习>学习</a>
<a href=http://sound2gd.wang/about/ title=关于>关于</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>Java NIO分析(8): 高并发核心Selector详解</h1></header><date class="post-meta meta-date">2018年7月12日</date><div class=post-content><p>上节<a href=/post/java-nio%E5%88%86%E6%9E%907-nio%E6%A0%B8%E5%BF%83%E4%B9%8Bchannelbuffer%E5%92%8Cselector%E7%AE%80%E4%BB%8B/>Java-NIO分析-7-NIO核心分析之Channel-Buffer和Selector</a>介绍了<code>Channel</code>，<code>Buffer</code>和<code>Selector</code>的基本用法
有了感性认识之后，来看看Selector的底层是如何实现的。</p><h1 id=1-selector设计>1. Selector设计</h1><p>笔者下载得是<a href=https://download.java.net/openjdk/jdk8>openjdk8</a>的源码, 画出类图</p><p>![](<a href=http://img.sound2gd.wang/2018/07/14/20180714234754.png-t>http://img.sound2gd.wang/2018/07/14/20180714234754.png-t</a></p><p>比较清晰得看到，openjdk中Selector的实现是<code>SelectorImpl</code>,
然后SelectorImpl又将职责委托给了具体的平台，比如图中框出的linux2.6以后才有的<code>EpollSelectorImpl</code>, Windows平台则是<code>WindowsSelectorImpl</code>, <code>MacOSX</code>平台是<code>KQueueSelectorImpl</code>.</p><p>从名字也可以猜到，openjdk肯定在底层还是用<code>epoll</code>,<code>kqueue</code>，<code>iocp</code>这些技术来实现的I/O多路复用。前面 <a href=/post/java-nio%E5%88%86%E6%9E%903-i/o%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bselect%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/>Java-NIO分析-3-I-O多路复用之select系统调用</a> ,<a href=/post/java-nio%E5%88%86%E6%9E%904-i/o%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bpoll%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/>Java-NIO分析-4-I-O多路复用之poll系统调用</a> , <a href=/post/java-nio%E5%88%86%E6%9E%905-i/o%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bepoll%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/>Java-NIO分析-5-I-O多路复用之epoll系统调用</a>写了3篇来说明其用法，感兴趣的读者可以回头看看。</p><h1 id=2-获取selector>2. 获取Selector</h1><p>众所周知，<code>Selector.open()</code>可以得到一个<code>Selector</code>实例，怎么实现的呢？</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#998;font-style:italic>// Selector.java
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>static</span> Selector <span style=color:#900;font-weight:700>open</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 首先找到provider,然后再打开Selector
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>return</span> SelectorProvider<span style=color:#000;font-weight:700>.</span><span style=color:teal>provider</span><span style=color:#000;font-weight:700>().</span><span style=color:teal>openSelector</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// java.nio.channels.spi.SelectorProvider
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>static</span> SelectorProvider <span style=color:#900;font-weight:700>provider</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>synchronized</span> <span style=color:#000;font-weight:700>(</span>lock<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>provider <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>return</span> provider<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>return</span> AccessController<span style=color:#000;font-weight:700>.</span><span style=color:teal>doPrivileged</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>new</span> PrivilegedAction<span style=color:#000;font-weight:700>&lt;</span>SelectorProvider<span style=color:#000;font-weight:700>&gt;()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>public</span> SelectorProvider <span style=color:#900;font-weight:700>run</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>loadProviderFromProperty<span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>return</span> provider<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>loadProviderAsService<span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>                                <span style=color:#000;font-weight:700>return</span> provider<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#998;font-style:italic>// 这里就是打开Selector的真正方法
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>                            provider <span style=color:#000;font-weight:700>=</span> sun<span style=color:#000;font-weight:700>.</span><span style=color:teal>nio</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>ch</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>DefaultSelectorProvider</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>create</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>                            <span style=color:#000;font-weight:700>return</span> provider<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>});</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在openjdk中，每个操作系统都有一个<code>sun.nio.ch.DefaultSelectorProvider</code>实现，以solaris为例:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#998;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * Returns the default SelectorProvider.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>static</span> SelectorProvider <span style=color:#900;font-weight:700>create</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 获取OS名称
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        String osname <span style=color:#000;font-weight:700>=</span> AccessController
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>.</span><span style=color:teal>doPrivileged</span><span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>new</span> GetPropertyAction<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;os.name&#34;</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 根据名称来创建不同的Selctor
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>osname<span style=color:#000;font-weight:700>.</span><span style=color:teal>equals</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;SunOS&#34;</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>return</span> createProvider<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;sun.nio.ch.DevPollSelectorProvider&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>osname<span style=color:#000;font-weight:700>.</span><span style=color:teal>equals</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;Linux&#34;</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>return</span> createProvider<span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;sun.nio.ch.EPollSelectorProvider&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>new</span> sun<span style=color:#000;font-weight:700>.</span><span style=color:teal>nio</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>ch</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>PollSelectorProvider</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果系统名称是<code>Linux</code>的话，真正创建的是<code>sun.nio.ch.EPollSelectorProvider</code>。如果不是SunOS也不是Linux,就使用<code>sun.nio.ch.PollSelectorProvider</code>, 关于<code>PollSelector</code>有兴趣的读者自行了解下, 本文仅以实际常用的<code>EpollSelector</code>为例探讨。</p><p>打开<code>sun.nio.ch.EPollSelectorProvider</code>查看<code>openSelector</code>方法</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#000;font-weight:700>public</span> AbstractSelector <span style=color:#900;font-weight:700>openSelector</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>new</span> EPollSelectorImpl<span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>this</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>很直观，这样我们在Linux平台就得到了最终的Selector实现:<code>sun.nio.ch.EPollSelectorImpl</code></p><h1 id=3-epollselector如何进行select>3. EPollSelector如何进行select</h1><p>epoll系统调用主要分为3个函数</p><ul><li>epoll_create: 创建一个epoll fd,并开辟epoll自己的内核高速cache区，建立红黑树，分配好想要的size的内存对象，建立一个list链表，用于存储准备就绪的事件。</li><li>epoll_wait: 等待内核返回IO事件</li><li>epoll_ctl: 对新旧事件进行新增修改或者删除</li></ul><h2 id=31-epoll-fd的创建>3.1 Epoll fd的创建</h2><p><code>EPollSelectorImpl</code>的构造器代码如下:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    EPollSelectorImpl<span style=color:#000;font-weight:700>(</span>SelectorProvider sp<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>super</span><span style=color:#000;font-weight:700>(</span>sp<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// makePipe返回管道的2个文件描述符，编码在一个long类型的变量中
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#998;font-style:italic>// 高32位代表读 低32位代表写
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#998;font-style:italic>// 使用pipe为了实现Selector的wakeup逻辑
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#458;font-weight:700>long</span> pipeFds <span style=color:#000;font-weight:700>=</span> IOUtil<span style=color:#000;font-weight:700>.</span><span style=color:teal>makePipe</span><span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>false</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        fd0 <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span>pipeFds <span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#099>32</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        fd1 <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> pipeFds<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 新建一个EPollArrayWrapper
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        pollWrapper <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> EPollArrayWrapper<span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        pollWrapper<span style=color:#000;font-weight:700>.</span><span style=color:teal>initInterrupt</span><span style=color:#000;font-weight:700>(</span>fd0<span style=color:#000;font-weight:700>,</span> fd1<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        fdToKey <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> HashMap<span style=color:#000;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>再看<code>EPollArrayWrapper</code>的初始化过程</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    EPollArrayWrapper<span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// creates the epoll file descriptor
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#998;font-style:italic>// 创建epoll fd
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        epfd <span style=color:#000;font-weight:700>=</span> epollCreate<span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// the epoll_event array passed to epoll_wait
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#458;font-weight:700>int</span> allocationSize <span style=color:#000;font-weight:700>=</span> NUM_EPOLLEVENTS <span style=color:#000;font-weight:700>*</span> SIZE_EPOLLEVENT<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        pollArray <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> AllocatedNativeObject<span style=color:#000;font-weight:700>(</span>allocationSize<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>true</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        pollArrayAddress <span style=color:#000;font-weight:700>=</span> pollArray<span style=color:#000;font-weight:700>.</span><span style=color:teal>address</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// eventHigh needed when using file descriptors &gt; 64k
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>OPEN_MAX <span style=color:#000;font-weight:700>&gt;</span> MAX_UPDATE_ARRAY_SIZE<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            eventsHigh <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> HashMap<span style=color:#000;font-weight:700>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>native</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>epollCreate</span><span style=color:#000;font-weight:700>();</span>
</span></span></code></pre></td></tr></table></div></div><p>在初始化过程中调用了<code>epollCreate</code>方法，这是个native方法。
打开<code>jdk/src/solaris/native/sun/nio/ch/EPollArrayWrapper.c</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>JNIEXPORT jint JNICALL
</span></span><span style=display:flex><span><span style=color:#900;font-weight:700>Java_sun_nio_ch_EPollArrayWrapper_epollCreate</span>(JNIEnv <span style=color:#000;font-weight:700>*</span>env, jobject this)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * epoll_create expects a size as a hint to the kernel about how to
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * dimension internal structures. We can&#39;t predict the size in advance.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     */</span>
</span></span><span style=display:flex><span>     <span style=color:#998;font-style:italic>// 这里的size可以不指定，从Linux2.6.8之后，改用了红黑树结构，指定了大小也没啥用
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#458;font-weight:700>int</span> epfd <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>epoll_create</span>(<span style=color:#099>256</span>);
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> (epfd <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#099>0</span>) {
</span></span><span style=display:flex><span>       <span style=color:#900;font-weight:700>JNU_ThrowIOExceptionWithLastError</span>(env, <span style=color:#d14>&#34;epoll_create failed&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>return</span> epfd;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>可以看到最后还是使用了操作系统的api: <code>epoll_create</code>函数</p><h2 id=32-epoll-wait等待内核io事件>3.2 Epoll wait等待内核IO事件</h2><p>调用<code>Selector.select()</code>,最后会委托给各个实现的<code>doSelect</code>方法,限于篇幅不贴出太详细的，这里看下<code>EpollSelectorImpl</code>的<code>doSelect</code>方法</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#000;font-weight:700>protected</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>doSelect</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>long</span> timeout<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>closed<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>throw</span> <span style=color:#000;font-weight:700>new</span> ClosedSelectorException<span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        processDeregisterQueue<span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            begin<span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>            <span style=color:#998;font-style:italic>// 真正的实现是这行
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>            pollWrapper<span style=color:#000;font-weight:700>.</span><span style=color:teal>poll</span><span style=color:#000;font-weight:700>(</span>timeout<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>finally</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            end<span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        processDeregisterQueue<span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#458;font-weight:700>int</span> numKeysUpdated <span style=color:#000;font-weight:700>=</span> updateSelectedKeys<span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 以下基本都是异常处理
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>pollWrapper<span style=color:#000;font-weight:700>.</span><span style=color:teal>interrupted</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#998;font-style:italic>// Clear the wakeup pipe
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>            pollWrapper<span style=color:#000;font-weight:700>.</span><span style=color:teal>putEventOps</span><span style=color:#000;font-weight:700>(</span>pollWrapper<span style=color:#000;font-weight:700>.</span><span style=color:teal>interruptedIndex</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>synchronized</span> <span style=color:#000;font-weight:700>(</span>interruptLock<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                pollWrapper<span style=color:#000;font-weight:700>.</span><span style=color:teal>clearInterrupted</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>                IOUtil<span style=color:#000;font-weight:700>.</span><span style=color:teal>drain</span><span style=color:#000;font-weight:700>(</span>fd0<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                interruptTriggered <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>false</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span> numKeysUpdated<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后我们去看<code>pollWrapper.poll</code>, 打开<code>jdk/src/solaris/classes/sun/nio/ch/EPollArrayWrapper.java</code>:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>poll</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>long</span> timeout<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        updateRegistrations<span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 这个epollWait是不是有点熟悉呢？
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        updated <span style=color:#000;font-weight:700>=</span> epollWait<span style=color:#000;font-weight:700>(</span>pollArrayAddress<span style=color:#000;font-weight:700>,</span> NUM_EPOLLEVENTS<span style=color:#000;font-weight:700>,</span> timeout<span style=color:#000;font-weight:700>,</span> epfd<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span> i<span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span><span style=color:#000;font-weight:700>;</span> i<span style=color:#000;font-weight:700>&lt;</span>updated<span style=color:#000;font-weight:700>;</span> i<span style=color:#000;font-weight:700>++)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>getDescriptor<span style=color:#000;font-weight:700>(</span>i<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>==</span> incomingInterruptFD<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                interruptedIndex <span style=color:#000;font-weight:700>=</span> i<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>                interrupted <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>break</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span> updated<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>native</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>epollWait</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>long</span> pollAddress<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>int</span> numfds<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>long</span> timeout<span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                 <span style=color:#458;font-weight:700>int</span> epfd<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException<span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>epollWait</code>也是个native方法,打开c代码一看:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>JNIEXPORT jint JNICALL
</span></span><span style=display:flex><span><span style=color:#900;font-weight:700>Java_sun_nio_ch_EPollArrayWrapper_epollWait</span>(JNIEnv <span style=color:#000;font-weight:700>*</span>env, jobject this,
</span></span><span style=display:flex><span>                                            jlong address, jint numfds,
</span></span><span style=display:flex><span>                                            jlong timeout, jint epfd)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>struct</span> epoll_event <span style=color:#000;font-weight:700>*</span>events <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>jlong_to_ptr</span>(address);
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> res;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> (timeout <span style=color:#000;font-weight:700>&lt;=</span> <span style=color:#099>0</span>) {           <span style=color:#998;font-style:italic>/* Indefinite or no wait */</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 发起epoll_wait系统调用等待内核事件
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#900;font-weight:700>RESTARTABLE</span>(<span style=color:#900;font-weight:700>epoll_wait</span>(epfd, events, numfds, timeout), res);
</span></span><span style=display:flex><span>    } <span style=color:#000;font-weight:700>else</span> {                      <span style=color:#998;font-style:italic>/* Bounded wait; bounded restarts */</span>
</span></span><span style=display:flex><span>        res <span style=color:#000;font-weight:700>=</span> <span style=color:#900;font-weight:700>iepoll</span>(epfd, events, numfds, timeout);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> (res <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#099>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#900;font-weight:700>JNU_ThrowIOExceptionWithLastError</span>(env, <span style=color:#d14>&#34;epoll_wait failed&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>return</span> res;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>可以看到，最后还是发起的<code>epoll_wait</code>系统调用.</p><h2 id=33-epoll-control以及openjdk对事件管理的封装>3.3 epoll control以及openjdk对事件管理的封装</h2><p>JDK中对于注册到Selector上的IO事件关系是使用<code>SelectionKey</code>来表示，代表了<code>Channel</code>感兴趣的事件，如<code>Read</code>,<code>Write</code>,<code>Connect</code>,<code>Accept</code>.</p><p>调用<code>Selector.register()</code>时均会将事件存储到<code>EpollArrayWrapper</code>的成员变量<code>eventsLow</code>和<code>eventsHigh</code>中</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// events for file descriptors with registration changes pending, indexed
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#998;font-style:italic>// by file descriptor and stored as bytes for efficiency reasons. For
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#998;font-style:italic>// file descriptors higher than MAX_UPDATE_ARRAY_SIZE (unlimited case at
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#998;font-style:italic>// least) then the update is stored in a map.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#998;font-style:italic>// 使用数组保存事件变更, 数组的最大长度是MAX_UPDATE_ARRAY_SIZE, 最大64*1024
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>final</span> <span style=color:#458;font-weight:700>byte</span><span style=color:#000;font-weight:700>[]</span> eventsLow <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> <span style=color:#458;font-weight:700>byte</span><span style=color:#000;font-weight:700>[</span>MAX_UPDATE_ARRAY_SIZE<span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// 超过数组长度的事件会缓存到这个map中，等待下次处理
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>private</span> Map<span style=color:#000;font-weight:700>&lt;</span>Integer<span style=color:#000;font-weight:700>,</span>Byte<span style=color:#000;font-weight:700>&gt;</span> eventsHigh<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * Sets the pending update events for the given file descriptor. This
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * method has no effect if the update events is already set to KILLED,
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * unless {@code force} is {@code true}.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>setUpdateEvents</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span> fd<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>byte</span> events<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>boolean</span> force<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>// 判断fd和数组长度
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>fd <span style=color:#000;font-weight:700>&lt;</span> MAX_UPDATE_ARRAY_SIZE<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>((</span>eventsLow<span style=color:#000;font-weight:700>[</span>fd<span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>!=</span> KILLED<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>||</span> force<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                eventsLow<span style=color:#000;font-weight:700>[</span>fd<span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> events<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            Integer key <span style=color:#000;font-weight:700>=</span> Integer<span style=color:#000;font-weight:700>.</span><span style=color:teal>valueOf</span><span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(!</span>isEventsHighKilled<span style=color:#000;font-weight:700>(</span>key<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>||</span> force<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                eventsHigh<span style=color:#000;font-weight:700>.</span><span style=color:teal>put</span><span style=color:#000;font-weight:700>(</span>key<span style=color:#000;font-weight:700>,</span> Byte<span style=color:#000;font-weight:700>.</span><span style=color:teal>valueOf</span><span style=color:#000;font-weight:700>(</span>events<span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面看到<code>EpollArrayWrapper.poll()</code>的时候, 首先会调用<code>updateRegistrations</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#998;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * Returns the pending update events for the given file descriptor.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#458;font-weight:700>byte</span> <span style=color:#900;font-weight:700>getUpdateEvents</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span> fd<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>fd <span style=color:#000;font-weight:700>&lt;</span> MAX_UPDATE_ARRAY_SIZE<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>return</span> eventsLow<span style=color:#000;font-weight:700>[</span>fd<span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            Byte result <span style=color:#000;font-weight:700>=</span> eventsHigh<span style=color:#000;font-weight:700>.</span><span style=color:teal>get</span><span style=color:#000;font-weight:700>(</span>Integer<span style=color:#000;font-weight:700>.</span><span style=color:teal>valueOf</span><span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>            <span style=color:#998;font-style:italic>// result should never be null
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>            <span style=color:#000;font-weight:700>return</span> result<span style=color:#000;font-weight:700>.</span><span style=color:teal>byteValue</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * Update the pending registrations.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>updateRegistrations</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>synchronized</span> <span style=color:#000;font-weight:700>(</span>updateLock<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#458;font-weight:700>int</span> j <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>while</span> <span style=color:#000;font-weight:700>(</span>j <span style=color:#000;font-weight:700>&lt;</span> updateCount<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#458;font-weight:700>int</span> fd <span style=color:#000;font-weight:700>=</span> updateDescriptors<span style=color:#000;font-weight:700>[</span>j<span style=color:#000;font-weight:700>];</span>
</span></span><span style=display:flex><span>                <span style=color:#998;font-style:italic>// 从保存的eventsLow和eventsHigh里取出事件
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>                <span style=color:#458;font-weight:700>short</span> events <span style=color:#000;font-weight:700>=</span> getUpdateEvents<span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#458;font-weight:700>boolean</span> isRegistered <span style=color:#000;font-weight:700>=</span> registered<span style=color:#000;font-weight:700>.</span><span style=color:teal>get</span><span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#458;font-weight:700>int</span> opcode <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>events <span style=color:#000;font-weight:700>!=</span> KILLED<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#998;font-style:italic>// 判断操作类型以传给epoll_ctl
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>                    <span style=color:#998;font-style:italic>// 没有指定EPOLLET事件类型
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>                    <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>isRegistered<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        opcode <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span>events <span style=color:#000;font-weight:700>!=</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>?</span> EPOLL_CTL_MOD <span style=color:#000;font-weight:700>:</span> EPOLL_CTL_DEL<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        opcode <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span>events <span style=color:#000;font-weight:700>!=</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>?</span> EPOLL_CTL_ADD <span style=color:#000;font-weight:700>:</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>opcode <span style=color:#000;font-weight:700>!=</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#998;font-style:italic>// 熟悉的epoll_ctl
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>                        epollCtl<span style=color:#000;font-weight:700>(</span>epfd<span style=color:#000;font-weight:700>,</span> opcode<span style=color:#000;font-weight:700>,</span> fd<span style=color:#000;font-weight:700>,</span> events<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>opcode <span style=color:#000;font-weight:700>==</span> EPOLL_CTL_ADD<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            registered<span style=color:#000;font-weight:700>.</span><span style=color:teal>set</span><span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>opcode <span style=color:#000;font-weight:700>==</span> EPOLL_CTL_DEL<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                            registered<span style=color:#000;font-weight:700>.</span><span style=color:teal>clear</span><span style=color:#000;font-weight:700>(</span>fd<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                j<span style=color:#000;font-weight:700>++;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            updateCount <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>native</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>epollCtl</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span> epfd<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>int</span> opcode<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>int</span> fd<span style=color:#000;font-weight:700>,</span> <span style=color:#458;font-weight:700>int</span> events<span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></td></tr></table></div></div><p>在获取到事件之后将操作委托给了<code>epollCtl</code>,这又是个native方法，打开相应的c代码一看:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>JNIEXPORT <span style=color:#458;font-weight:700>void</span> JNICALL
</span></span><span style=display:flex><span><span style=color:#900;font-weight:700>Java_sun_nio_ch_EPollArrayWrapper_epollCtl</span>(JNIEnv <span style=color:#000;font-weight:700>*</span>env, jobject this, jint epfd,
</span></span><span style=display:flex><span>                                           jint opcode, jint fd, jint events)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>struct</span> epoll_event event;
</span></span><span style=display:flex><span>    <span style=color:#458;font-weight:700>int</span> res;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    event.events <span style=color:#000;font-weight:700>=</span> events;
</span></span><span style=display:flex><span>    event.data.fd <span style=color:#000;font-weight:700>=</span> fd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// 发起epoll_ctl调用来进行IO事件的管理
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#900;font-weight:700>RESTARTABLE</span>(<span style=color:#900;font-weight:700>epoll_ctl</span>(epfd, (<span style=color:#458;font-weight:700>int</span>)opcode, (<span style=color:#458;font-weight:700>int</span>)fd, <span style=color:#000;font-weight:700>&amp;</span>event), res);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * A channel may be registered with several Selectors. When each Selector
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * is polled a EPOLL_CTL_DEL op will be inserted into its pending update
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * list to remove the file descriptor from epoll. The &#34;last&#34; Selector will
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * close the file descriptor which automatically unregisters it from each
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * epoll descriptor. To avoid costly synchronization between Selectors we
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * allow pending updates to be processed, ignoring errors. The errors are
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * harmless as the last update for the file descriptor is guaranteed to
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     * be EPOLL_CTL_DEL.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> (res <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#099>0</span> <span style=color:#000;font-weight:700>&amp;&amp;</span> errno <span style=color:#000;font-weight:700>!=</span> EBADF <span style=color:#000;font-weight:700>&amp;&amp;</span> errno <span style=color:#000;font-weight:700>!=</span> ENOENT <span style=color:#000;font-weight:700>&amp;&amp;</span> errno <span style=color:#000;font-weight:700>!=</span> EPERM) {
</span></span><span style=display:flex><span>        <span style=color:#900;font-weight:700>JNU_ThrowIOExceptionWithLastError</span>(env, <span style=color:#d14>&#34;epoll_ctl failed&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>原来还是我们的老朋友<code>epoll_ctl</code>.
有个小细节是jdk没有指定<code>ET(边缘触发)</code>还是<code>LT(水平触发)</code>,所以默认会用<code>LT</code>:)</p><p>在<code>AbstractSelectorImpl</code>中有3个set保存事件</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#998;font-style:italic>// Public views of the key sets
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#998;font-style:italic>// 注册的所有事件
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>private</span> Set<span style=color:#000;font-weight:700>&lt;</span>SelectionKey<span style=color:#000;font-weight:700>&gt;</span> publicKeys<span style=color:#000;font-weight:700>;</span>             <span style=color:#998;font-style:italic>// Immutable
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#998;font-style:italic>// 内核返回的IO事件封装，表示哪些fd有数据可读可写
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>private</span> Set<span style=color:#000;font-weight:700>&lt;</span>SelectionKey<span style=color:#000;font-weight:700>&gt;</span> publicSelectedKeys<span style=color:#000;font-weight:700>;</span>     <span style=color:#998;font-style:italic>// Removal allowed, but not addition
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>// 取消的事件
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>final</span> Set<span style=color:#000;font-weight:700>&lt;</span>SelectionKey<span style=color:#000;font-weight:700>&gt;</span> cancelledKeys <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> HashSet<span style=color:#000;font-weight:700>&lt;</span>SelectionKey<span style=color:#000;font-weight:700>&gt;();</span>
</span></span></code></pre></td></tr></table></div></div><p>在<code>EpollArrayWrapper.poll</code>调用完成之后, 会调用<code>updateSelectedKeys</code>来更新上面的仨set</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>updateSelectedKeys</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#458;font-weight:700>int</span> entries <span style=color:#000;font-weight:700>=</span> pollWrapper<span style=color:#000;font-weight:700>.</span><span style=color:teal>updated</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#458;font-weight:700>int</span> numKeysUpdated <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span> i<span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span><span style=color:#000;font-weight:700>;</span> i<span style=color:#000;font-weight:700>&lt;</span>entries<span style=color:#000;font-weight:700>;</span> i<span style=color:#000;font-weight:700>++)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#458;font-weight:700>int</span> nextFD <span style=color:#000;font-weight:700>=</span> pollWrapper<span style=color:#000;font-weight:700>.</span><span style=color:teal>getDescriptor</span><span style=color:#000;font-weight:700>(</span>i<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            SelectionKeyImpl ski <span style=color:#000;font-weight:700>=</span> fdToKey<span style=color:#000;font-weight:700>.</span><span style=color:teal>get</span><span style=color:#000;font-weight:700>(</span>Integer<span style=color:#000;font-weight:700>.</span><span style=color:teal>valueOf</span><span style=color:#000;font-weight:700>(</span>nextFD<span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>            <span style=color:#998;font-style:italic>// ski is null in the case of an interrupt
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>            <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>ski <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#458;font-weight:700>int</span> rOps <span style=color:#000;font-weight:700>=</span> pollWrapper<span style=color:#000;font-weight:700>.</span><span style=color:teal>getEventOps</span><span style=color:#000;font-weight:700>(</span>i<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>selectedKeys<span style=color:#000;font-weight:700>.</span><span style=color:teal>contains</span><span style=color:#000;font-weight:700>(</span>ski<span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>ski<span style=color:#000;font-weight:700>.</span><span style=color:teal>channel</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>translateAndSetReadyOps</span><span style=color:#000;font-weight:700>(</span>rOps<span style=color:#000;font-weight:700>,</span> ski<span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        numKeysUpdated<span style=color:#000;font-weight:700>++;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                    ski<span style=color:#000;font-weight:700>.</span><span style=color:teal>channel</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>translateAndSetReadyOps</span><span style=color:#000;font-weight:700>(</span>rOps<span style=color:#000;font-weight:700>,</span> ski<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>((</span>ski<span style=color:#000;font-weight:700>.</span><span style=color:teal>nioReadyOps</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>&amp;</span> ski<span style=color:#000;font-weight:700>.</span><span style=color:teal>nioInterestOps</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>!=</span> <span style=color:#099>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                        selectedKeys<span style=color:#000;font-weight:700>.</span><span style=color:teal>add</span><span style=color:#000;font-weight:700>(</span>ski<span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                        numKeysUpdated<span style=color:#000;font-weight:700>++;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>return</span> numKeysUpdated<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><p>代码很直白，拿出事件对set比对操作。</p><h1 id=4-总结>4. 总结</h1><p>![](<a href=http://img.sound2gd.wang/2018/07/15/20180715101407.png-t>http://img.sound2gd.wang/2018/07/15/20180715101407.png-t</a></p><p>jdk中<code>Selector</code>是对操作系统的IO多路复用调用的一个封装，在Linux中就是对<code>epoll</code>的封装。epoll实质上是将<code>event loop</code>交给了内核，因为网络数据都是首先到内核的，直接内核处理可以避免无谓的系统调用和数据拷贝, 性能是最好的。</p><p>jdk中对IO事件的封装是<code>SelectionKey</code>, 保存<code>Channel</code>关心的事件。</p><p>至此对Selector的前后实现比较清晰了.</p></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=http://sound2gd.wang/>Chris Wang</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=http://sound2gd.wang/post/java-nio%E5%88%86%E6%9E%908-%E9%AB%98%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83selector%E8%AF%A6%E8%A7%A3/>http://sound2gd.wang/post/java-nio%E5%88%86%E6%9E%908-%E9%AB%98%E5%B9%B6%E5%8F%91%E6%A0%B8%E5%BF%83selector%E8%AF%A6%E8%A7%A3/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/4.0/>知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li></ul></div><br><div class=post-archive><h2>See Also</h2><ul class=listing><li><a href=/post/java-nio%E5%88%86%E6%9E%907-nio%E6%A0%B8%E5%BF%83%E4%B9%8Bchannelbuffer%E5%92%8Cselector%E7%AE%80%E4%BB%8B/>Java NIO分析(7): NIO核心之Channel,Buffer和Selector简介</a></li><li><a href=/post/java-nio%E5%88%86%E6%9E%906-%E4%BB%8Ebio%E5%88%B0nio-%E8%AE%BE%E8%AE%A1%E5%92%8C%E6%A6%82%E5%BF%B5/>Java NIO分析(6): 从BIO到NIO-设计和概念</a></li><li><a href=/post/java-nio%E5%88%86%E6%9E%905-i/o%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bepoll%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/>Java NIO分析(5): I/O多路复用之epoll系统调用</a></li><li><a href=/post/java-nio%E5%88%86%E6%9E%904-i/o%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bpoll%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/>Java NIO分析(4): I/O多路复用之poll系统调用</a></li><li><a href=/post/java-nio%E5%88%86%E6%9E%903-i/o%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bselect%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/>Java NIO分析(3): I/O多路复用之select系统调用</a></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a href=/tags/nio>NIO</a></li></ul></div></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=sound2gd/blog-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2023 <a href=http://sound2gd.wang/>Chris的博客 By Chris Wang</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>浙ICP备18046106号</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src=https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N5MSKS0SN8"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N5MSKS0SN8",{anonymize_ip:!1})}</script></div><div id=secondary><section class=widget><form id=search action=http://sound2gd.wang/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=http://sound2gd.wang/>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=http://sound2gd.wang/post/bcd1a91c/ title=盘点rust写的好用命令行工具>盘点rust写的好用命令行工具</a></li><li><a href=http://sound2gd.wang/post/556f376d/ title=2022年Clojure技术栈推荐>2022年Clojure技术栈推荐</a></li><li><a href=http://sound2gd.wang/post/jvm%E6%8B%BE%E9%81%975-%E5%AF%B9%E8%B1%A1%E5%A4%A7%E5%B0%8F%E8%AE%A1%E7%AE%97/ title="JVM拾遗(5): 对象大小计算">JVM拾遗(5): 对象大小计算</a></li><li><a href=http://sound2gd.wang/post/jvm%E6%8B%BE%E9%81%974-java%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA%E5%8F%8A%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/ title="JVM拾遗(4): Java对象的创建及内存布局">JVM拾遗(4): Java对象的创建及内存布局</a></li><li><a href=http://sound2gd.wang/post/jvm%E6%8B%BE%E9%81%973-%E7%B1%BB%E8%A3%85%E8%BD%BD%E6%9C%BA%E5%88%B6/ title="JVM拾遗(3): 类装载机制">JVM拾遗(3): 类装载机制</a></li><li><a href=http://sound2gd.wang/post/jvm%E6%8B%BE%E9%81%972-%E5%B9%B3%E5%8F%B0%E6%97%A0%E5%85%B3%E6%80%A7%E5%9F%BA%E7%9F%B3%E4%B9%8Bclass%E8%A7%A3%E6%9E%90/ title="JVM拾遗(2): 平台无关性基石之Class解析">JVM拾遗(2): 平台无关性基石之Class解析</a></li><li><a href=http://sound2gd.wang/post/jvm%E6%8B%BE%E9%81%971-%E4%B8%87%E7%B1%B3%E9%AB%98%E7%A9%BA%E7%9C%8Bjvm/ title="JVM拾遗(1): 万米高空看JVM">JVM拾遗(1): 万米高空看JVM</a></li><li><a href=http://sound2gd.wang/post/java-nio%E5%88%86%E6%9E%9012-nio%E6%80%BB%E7%BB%93/ title="Java NIO分析(12): NIO总结">Java NIO分析(12): NIO总结</a></li><li><a href=http://sound2gd.wang/post/java-nio%E5%88%86%E6%9E%9011-%E9%9B%B6%E6%8B%B7%E8%B4%9D%E6%8A%80%E6%9C%AF%E4%BB%A5%E5%8F%8Anio%E7%9A%84%E6%94%AF%E6%8C%81/ title="Java NIO分析(11): 零拷贝技术以及NIO的支持">Java NIO分析(11): 零拷贝技术以及NIO的支持</a></li><li><a href=http://sound2gd.wang/post/java-nio%E5%88%86%E6%9E%9010-jvm%E5%A0%86%E5%A4%96%E5%86%85%E5%AD%98%E5%88%A9%E7%94%A8%E6%94%B9%E8%BF%9B-directbuffer%E8%AF%A6%E8%A7%A3/ title="Java NIO分析(10): JVM堆外内存利用改进: DirectBuffer详解">Java NIO分析(10): JVM堆外内存利用改进: DirectBuffer详解</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list><li><a href=http://sound2gd.wang/categories/clojure/>Clojure (1)</a></li><li><a href=http://sound2gd.wang/categories/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/>年终总结 (1)</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud><a href=http://sound2gd.wang/tags/2021/>2021</a>
<a href=http://sound2gd.wang/tags/clojure/>Clojure</a>
<a href=http://sound2gd.wang/tags/java-jvm/>JAVA JVM</a>
<a href=http://sound2gd.wang/tags/jvm-java/>JVM JAVA</a>
<a href=http://sound2gd.wang/tags/nio/>NIO</a>
<a href=http://sound2gd.wang/tags/nio-linux/>NIO Linux</a>
<a href=http://sound2gd.wang/tags/%E4%BA%BA%E7%94%9F/>人生</a>
<a href=http://sound2gd.wang/tags/%E5%B7%A5%E7%A8%8B%E6%8A%80%E6%9C%AF/>工程技术</a>
<a href=http://sound2gd.wang/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/>年终总结</a>
<a href=http://sound2gd.wang/tags/%E6%9D%82%E8%B0%88/>杂谈</a></div></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=http://sound2gd.wang/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>